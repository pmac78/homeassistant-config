- id: hws_predictive_control
  alias: "HWS - Predictive Solar Control"
  description: "Smart water heating - plans ahead for heating cycles"
  mode: restart
  
  trigger:
    # Check every 5 minutes
    - platform: time_pattern
      minutes: "/5"
    
    # Immediate trigger when conditions are ideal
    - platform: numeric_state
      entity_id: sensor.victron_mqtt_system_0_system_dc_battery_soc
      above: 80
      for: "00:02:00"
    
    # Solar production trigger
    - platform: numeric_state
      entity_id: sensor.victron_mqtt_system_0_system_dc_pv_power
      above: 1200
      for: "00:02:00"
  
  variables:
    # Current state
    current_soc: "{{ states('sensor.victron_mqtt_system_0_system_dc_battery_soc') | float(0) }}"
    current_solar: "{{ states('sensor.victron_mqtt_system_0_system_dc_pv_power') | float(0) }}"
    current_load: "{{ states('sensor.total_system_consumption_power') | float(0) }}"
    battery_power: "{{ states('sensor.victron_mqtt_system_0_system_dc_battery_power') | float(0) }}"
    battery_capacity: "{{ states('input_number.battery_capacity_kwh') | float(10) }}"
    
    # Forecasts
    solar_remaining: "{{ states('sensor.solcast_pv_forecast_forecast_remaining_today') | float(0) }}"
    solar_this_hour: "{{ states('sensor.solcast_pv_forecast_forecast_this_hour') | float(0) }}"
    solar_next_hour: "{{ states('sensor.solcast_pv_forecast_forecast_next_hour') | float(0) }}"
    
    # Energy calculations
    energy_to_full: "{{ (((100 - current_soc) / 100) * battery_capacity) | round(2) }}"
    heating_energy: 0.75  # 45 mins at 900W
    buffer: 2.0  # Evening usage safety margin
    total_energy_needed: "{{ (energy_to_full + heating_energy + buffer) | round(2) }}"
    
    # Can we afford a heating cycle?
    can_afford_heating: "{{ solar_remaining > total_energy_needed }}"
    energy_headroom: "{{ (solar_remaining - total_energy_needed) | round(2) }}"
    
    # Current surplus
    current_surplus: "{{ current_solar - current_load }}"
    is_charging: "{{ battery_power > 0 }}"
    
    # Heating score
    heating_score: "{{ states('sensor.hws_heating_score') | int(0) }}"
    
    # Time checks
    is_daytime: >
      {% set now_hour = now().hour %}
      {{ now_hour >= 7 and now_hour <= 17 }}
    
    hours_until_sunset: >
      {% set sunset = state_attr('sun.sun', 'next_setting') %}
      {% if sunset %}
        {{ ((sunset - now()).total_seconds() / 3600) | round(1) }}
      {% else %}
        8
      {% endif %}
    
    # Minimum solar to sustain heating
    min_solar_for_eco: 900
  
  condition:
    - condition: template
      value_template: "{{ is_daytime }}"
    - condition: template
      value_template: "{{ hours_until_sunset > 2 }}"  # Don't start within 2h of sunset
  
  action:
    - choose:
        # =============================================
        # PRIORITY 1: Battery full, solar being wasted
        # =============================================
        - conditions:
            - condition: template
              value_template: "{{ current_soc > 97 }}"
            - condition: template
              value_template: "{{ solar_remaining > 3 }}"
            - condition: state
              entity_id: switch.hws
              state: "off"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.hws
        
        # =============================================
        # PRIORITY 2: Predictive start - can afford it
        # =============================================
        - conditions:
            - condition: template
              value_template: "{{ can_afford_heating }}"
            - condition: template
              value_template: "{{ energy_headroom > 1 }}"  # At least 1kWh extra
            - condition: template
              value_template: "{{ current_soc > 75 }}"  # Battery reasonably charged
            - condition: template
              value_template: "{{ current_solar > min_solar_for_eco }}"  # Enough solar NOW
            - condition: template
              value_template: "{{ solar_this_hour > 0.8 }}"  # Good forecast this hour
            - condition: template
              value_template: "{{ hours_until_sunset > 3 }}"  # Enough time
            - condition: state
              entity_id: switch.hws
              state: "off"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.hws
        
        # =============================================
        # PRIORITY 3: Traditional surplus-based start
        # =============================================
        - conditions:
            - condition: template
              value_template: "{{ heating_score >= 60 }}"
            - condition: template
              value_template: "{{ current_soc > 85 }}"
            - condition: template
              value_template: "{{ current_surplus > 1100 }}"
            - condition: state
              entity_id: switch.hws
              state: "off"
            - condition: template
              value_template: "{{ is_charging }}"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.hws
        
        # =============================================
        # KEEP RUNNING - While conditions are OK
        # =============================================
        - conditions:
            - condition: state
              entity_id: switch.hws
              state: "on"
            - condition: or
              conditions:
                # Option A: Good solar production
                - condition: template
                  value_template: "{{ current_solar > min_solar_for_eco * 0.8 }}"
                # Option B: Battery can cover shortfall
                - condition: template
                  value_template: "{{ current_soc > 85 and can_afford_heating }}"
            - condition: template
              value_template: "{{ current_soc > 70 }}"
          sequence:
            - delay: "00:00:01"
        
        # =============================================
        # STOP HEATING
        # =============================================
        - conditions:
            - condition: state
              entity_id: switch.hws
              state: "on"
            - condition: or
              conditions:
                # Solar dropped too low
                - condition: template
                  value_template: "{{ current_solar < min_solar_for_eco * 0.6 }}"
                # Battery getting low
                - condition: template
                  value_template: "{{ current_soc < 70 }}"
                # Can no longer afford it
                - condition: template
                  value_template: "{{ not can_afford_heating and current_soc < 90 }}"
                # Too close to sunset
                - condition: template
                  value_template: "{{ hours_until_sunset < 1.5 }}"
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.hws

      default: []

# Safety stop at sunset
- id: hws_sunset_safety
  alias: "HWS - Sunset Safety Stop"
  trigger:
    - platform: sun
      event: sunset
      offset: "-01:30:00"
  condition:
    - condition: state
      entity_id: switch.hws
      state: "on"
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.hws












- id: '1756966157065'
  alias: Switch 1_1 - Toggle Maglocks
  description: ''
  triggers:
  - device_id: afb4ceb1f6b3a9031a2a3707bb1901e0
    domain: zha
    type: remote_button_short_press
    subtype: button_1
    trigger: device
  conditions: []
  actions:
  - type: toggle
    device_id: 7603f297b0a3a73e9808648640f06b64
    entity_id: 249de4b849a8dce4f7194e0a8ae2c741
    domain: switch
  mode: single

- id: switch_1_1_long_bed_lift
  alias: "Switch 1_1 Long - Bed Lift Timer"
  description: "Long press button 1 on Switch 1 to activate Bed Lift for 3 minutes"
  triggers:
  - device_id: afb4ceb1f6b3a9031a2a3707bb1901e0
    domain: zha
    type: remote_button_long_press
    subtype: button_1
    trigger: device
  conditions: []
  actions:
  - service: switch.turn_on
    target:
      entity_id: switch.bed_lift
  - delay:
      minutes: 3
  - service: switch.turn_off
    target:
      entity_id: switch.bed_lift
  mode: restart

- id: switch_1_3_arrive_camp
  alias: "Switch 1_3 - Arrive at Camp"
  description: "Short press button 3 to enable all camp services and lighting"
  triggers:
  - device_id: afb4ceb1f6b3a9031a2a3707bb1901e0
    domain: zha
    type: remote_button_short_press
    subtype: button_3
    trigger: device
  conditions: []
  actions:
  # F16 Switches
  - service: switch.turn_off
    target:
      entity_id: switch.mag_locks
  - service: switch.turn_on
    target:
      entity_id:
        - switch.hws
        - switch.starlink
        - switch.quinled_an1
        - switch.quinled_an2
        - switch.towel_rails
        - switch.usb_outlets
        - switch.water_pump_internal
  # B16M Switches
  - service: switch.turn_on
    target:
      entity_id:
        - switch.b16m_output12  # Roof Hatch Fan
        - switch.b16m_output14  # Ventilation Couch
        - switch.b16m_output13  # Ventilation Fridge
        - switch.b16m_output16  # Sensor Power 12v
        - switch.b16m_output06  # Sensor Power 24v
  # Shelly 240v Switches
  - service: switch.turn_on
    target:
      entity_id:
        - switch.shellypro4pm_6825ddd5de40_switch_3  # AC
        - switch.shellypro4pm_8813bff257a4_switch_1  # Dishwasher
        - switch.shellypro4pm_8813bff257a4_switch_3  # Fridge
        - switch.shellypro4pm_8813bff257a4_switch_0  # Microwave
  - service: switch.turn_off
    target:
      entity_id: switch.shellypro4pm_6825ddd5de40_switch_2  # HWS 240v (controlled by other automations)
  # Arrival Lighting - daytime 50%, nighttime 75%
  - choose:
      - conditions:
          - condition: sun
            after: sunset
        sequence:
          - service: light.turn_on
            target:
              entity_id:
                - light.kickboard
                - light.dining
                - light.ceiling
            data:
              brightness_pct: 75
    default:
      - service: light.turn_on
        target:
          entity_id:
            - light.kickboard
            - light.dining
            - light.ceiling
        data:
          brightness_pct: 50
  mode: single

- id: switch_1_3_long_prepare_drive
  alias: "Switch 1_3 Long - Prepare to Drive"
  description: "Long press button 3 to disable non-essential services for travel"
  triggers:
  - device_id: afb4ceb1f6b3a9031a2a3707bb1901e0
    domain: zha
    type: remote_button_long_press
    subtype: button_3
    trigger: device
  conditions: []
  actions:
  # Lock cabinets for travel
  - service: switch.turn_on
    target:
      entity_id: switch.mag_locks
  # Turn off non-essentials (keep F16 HWS on for travel)
  - service: switch.turn_off
    target:
      entity_id:
        - switch.quinled_an1
        - switch.quinled_an2
        - switch.towel_rails
        - switch.water_pump_internal
        - switch.b16m_output12  # Roof Hatch Fan
  # Keep these ON: Starlink, USB Outlets, Sensor Power, Ventilation, Fridge
  - service: switch.turn_on
    target:
      entity_id:
        - switch.starlink
        - switch.usb_outlets
        - switch.b16m_output16  # Sensor Power 12v
        - switch.b16m_output06  # Sensor Power 24v
        - switch.b16m_output14  # Ventilation Couch
        - switch.b16m_output13  # Ventilation Fridge
        - switch.shellypro4pm_8813bff257a4_switch_3  # Fridge (always on)
  # Turn off 240v non-essentials
  - service: switch.turn_off
    target:
      entity_id:
        - switch.shellypro4pm_6825ddd5de40_switch_3  # AC
        - switch.shellypro4pm_6825ddd5de40_switch_2  # HWS 240v
        - switch.shellypro4pm_8813bff257a4_switch_1  # Dishwasher
        - switch.shellypro4pm_8813bff257a4_switch_0  # Microwave
  # Turn off all lights
  - service: light.turn_off
    target:
      entity_id:
        - light.dining
        - light.cabinets
        - light.kickboard
        - light.ceiling
        - light.bathroom
        - light.rear_bed
        - light.steps
  mode: single

- id: grey_water_valve_auto_off
  alias: "Grey Water Valve - Auto Off Timer"
  description: "Automatically turn off grey water valve after 10 minutes"
  triggers:
  - platform: state
    entity_id: switch.b16m_output05
    to: "on"
    trigger: state
  conditions: []
  actions:
  - delay:
      minutes: 10
  - service: switch.turn_off
    target:
      entity_id: switch.b16m_output05
  mode: restart

- id: switch_4_2_cycle_rear_bed
  alias: "Switch 4_2 - Cycle Rear Bed Brightness"
  description: "Cycle rear bed light: Off → 20% → 60% → 100% → Off"
  triggers:
  - device_id: 9fe3098ad9d55efaf1171d5dc780c79b
    domain: zha
    type: remote_button_short_press
    subtype: button_2
    trigger: device
  conditions: []
  actions:
  - choose:
      # If OFF → turn on at 20%
      - conditions:
          - condition: state
            entity_id: light.rear_bed
            state: "off"
        sequence:
          - service: light.turn_on
            target:
              entity_id: light.rear_bed
            data:
              brightness_pct: 20
      # If at ~20% (brightness <= 55) → set to 60%
      - conditions:
          - condition: state
            entity_id: light.rear_bed
            state: "on"
          - condition: numeric_state
            entity_id: light.rear_bed
            attribute: brightness
            below: 56
        sequence:
          - service: light.turn_on
            target:
              entity_id: light.rear_bed
            data:
              brightness_pct: 60
      # If at ~60% (brightness 56-160) → set to 100%
      - conditions:
          - condition: state
            entity_id: light.rear_bed
            state: "on"
          - condition: numeric_state
            entity_id: light.rear_bed
            attribute: brightness
            above: 55
            below: 161
        sequence:
          - service: light.turn_on
            target:
              entity_id: light.rear_bed
            data:
              brightness_pct: 100
      # If at ~100% (brightness > 160) → turn off
      - conditions:
          - condition: state
            entity_id: light.rear_bed
            state: "on"
          - condition: numeric_state
            entity_id: light.rear_bed
            attribute: brightness
            above: 160
        sequence:
          - service: light.turn_off
            target:
              entity_id: light.rear_bed
  mode: single

- id: switch_4_1_cycle_bathroom
  alias: "Switch 4_1 - Cycle Bathroom Brightness"
  description: "Cycle bathroom light: Off → 20% → 50% → 100% → Off"
  triggers:
  - device_id: 9fe3098ad9d55efaf1171d5dc780c79b
    domain: zha
    type: remote_button_short_press
    subtype: button_1
    trigger: device
  conditions: []
  actions:
  - choose:
      # If OFF → turn on at 20%
      - conditions:
          - condition: state
            entity_id: light.bathroom
            state: "off"
        sequence:
          - service: light.turn_on
            target:
              entity_id: light.bathroom
            data:
              brightness_pct: 20
      # If at ~20% (brightness <= 55) → set to 50%
      - conditions:
          - condition: state
            entity_id: light.bathroom
            state: "on"
          - condition: numeric_state
            entity_id: light.bathroom
            attribute: brightness
            below: 56
        sequence:
          - service: light.turn_on
            target:
              entity_id: light.bathroom
            data:
              brightness_pct: 50
      # If at ~50% (brightness 56-140) → set to 100%
      - conditions:
          - condition: state
            entity_id: light.bathroom
            state: "on"
          - condition: numeric_state
            entity_id: light.bathroom
            attribute: brightness
            above: 55
            below: 141
        sequence:
          - service: light.turn_on
            target:
              entity_id: light.bathroom
            data:
              brightness_pct: 100
      # If at ~100% (brightness > 140) → turn off
      - conditions:
          - condition: state
            entity_id: light.bathroom
            state: "on"
          - condition: numeric_state
            entity_id: light.bathroom
            attribute: brightness
            above: 140
        sequence:
          - service: light.turn_off
            target:
              entity_id: light.bathroom
  mode: single

- id: switch_4_1_double_bathroom_off
  alias: "Switch 4_1 Double - Bathroom Off"
  description: "Double press button 1 to turn off bathroom light"
  triggers:
  - device_id: 9fe3098ad9d55efaf1171d5dc780c79b
    domain: zha
    type: remote_button_double_press
    subtype: button_1
    trigger: device
  conditions: []
  actions:
  - service: light.turn_off
    target:
      entity_id: light.bathroom
  mode: single

- id: switch_4_2_double_rear_bed_off
  alias: "Switch 4_2 Double - Rear Bed Off"
  description: "Double press button 2 to turn off rear bed light"
  triggers:
  - device_id: 9fe3098ad9d55efaf1171d5dc780c79b
    domain: zha
    type: remote_button_double_press
    subtype: button_2
    trigger: device
  conditions: []
  actions:
  - service: light.turn_off
    target:
      entity_id: light.rear_bed
  mode: single

- id: '1763275768553'
  alias: Switch 2_1 -  Toggle Flood Passenger
  description: ''
  triggers:
  - device_id: 353178ba46eeae1368139fda0f53ef9b
    domain: zha
    type: remote_button_short_press
    subtype: button_1
    trigger: device
  conditions: []
  actions:
  - type: toggle
    device_id: 7603f297b0a3a73e9808648640f06b64
    entity_id: fc523df94c326a14d1190a719f8def4a
    domain: switch
  mode: single
- id: '1763275814961'
  alias: Switch 2_2 -  Toggle Flood Rear
  description: ''
  triggers:
  - device_id: 353178ba46eeae1368139fda0f53ef9b
    domain: zha
    type: remote_button_short_press
    subtype: button_2
    trigger: device
  conditions: []
  actions:
  - type: toggle
    device_id: 7603f297b0a3a73e9808648640f06b64
    entity_id: 19220a5e8ef32d3361e2ee59bcca7ac5
    domain: switch
  mode: single
- id: '1763275840429'
  alias: Switch 2_3 - Toggle Flood Drivers
  description: ''
  triggers:
  - device_id: 353178ba46eeae1368139fda0f53ef9b
    domain: zha
    type: remote_button_short_press
    subtype: button_3
    trigger: device
  conditions: []
  actions:
  - type: toggle
    device_id: 7603f297b0a3a73e9808648640f06b64
    entity_id: 88b22423ce347dbdddb9f736d9095b71
    domain: switch
  mode: single
- id: '1763276161137'
  alias: Switch 2_1_Long - All Floods On
  description: ''
  triggers:
  - device_id: 353178ba46eeae1368139fda0f53ef9b
    domain: zha
    type: remote_button_double_press
    subtype: button_1
    trigger: device
  conditions: []
  actions:
  - parallel:
    - type: turn_on
      device_id: 7603f297b0a3a73e9808648640f06b64
      entity_id: fc523df94c326a14d1190a719f8def4a
      domain: switch
    - type: turn_on
      device_id: 7603f297b0a3a73e9808648640f06b64
      entity_id: 88b22423ce347dbdddb9f736d9095b71
      domain: switch
    - type: turn_on
      device_id: 7603f297b0a3a73e9808648640f06b64
      entity_id: 19220a5e8ef32d3361e2ee59bcca7ac5
      domain: switch
  mode: single
- id: '1763552078880'
  alias: Toggle Dining Light
  description: ''
  triggers:
  - device_id: 6bb5485c6dd4e19593bff840017a3c59
    domain: zha
    type: remote_button_short_press
    subtype: button_1
    trigger: device
  conditions: []
  actions:
  - type: toggle
    device_id: 38b2c056d476a5d434543a507635eb7c
    entity_id: 360ef382d3bea73d815c69750ccf5b2a
    domain: light
  mode: single
- id: '1763552190934'
  alias: Trigger Nighlight
  description: ''
  triggers:
  - device_id: 6bb5485c6dd4e19593bff840017a3c59
    domain: zha
    type: remote_button_short_press
    subtype: button_2
    trigger: device
  conditions: []
  actions:
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.nightlight
  mode: single

# ============================================================
# DOOR-TRIGGERED STEP LIGHTS
# Turns on Steps WLED when main door opens at night
# ============================================================
- id: steps_light_on_door_open
  alias: "Steps Light - Door Open at Night"
  description: "Turn Steps WLED to full brightness when main door opens after dark"
  mode: restart

  trigger:
    - platform: state
      entity_id: binary_sensor.main_door_sensor_opening
      to: "on"

  condition:
    # Only run after sunset and before sunrise
    - condition: or
      conditions:
        - condition: sun
          after: sunset
        - condition: sun
          before: sunrise

  action:
    # Save current state of Steps light
    - service: scene.create
      data:
        scene_id: steps_before_door
        snapshot_entities:
          - light.steps

    # Turn Steps to full brightness
    - service: light.turn_on
      target:
        entity_id: light.steps
      data:
        brightness: 255

    # Wait 2 minutes
    - delay:
        minutes: 2

    # Restore previous state
    - service: scene.turn_on
      target:
        entity_id: scene.steps_before_door

- id: '1763552509172'
  alias: Trigger Bright Lights
  description: ''
  triggers:
  - device_id: 6bb5485c6dd4e19593bff840017a3c59
    domain: zha
    type: remote_button_double_press
    subtype: button_2
    trigger: device
  conditions: []
  actions:
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.bright_lights
  mode: single
